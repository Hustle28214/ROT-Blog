## 中断系统

中断：在主程序运行过程中，出现了特定的中断触发条件（中断源），使得CPU暂停当前正在运行的程序，转而去处理中断程序，处理完成后又返回原来被暂停的位置继续运行。

中断优先级：当有多个中断源同时申请中断时，CPU会根据中断源的轻重缓急进行裁决，优先响应更加紧急的中断源。

中断嵌套：当一个中断程序正在运行时，又有新的更高优先级的中断源申请中断，CPU再次暂停当前中断程序，转而去处理新的中断程序，处理完成后依次进行返回。**可以简单地理解为将中断程序作为另一个主程序又套了一个中断。**

## STM32中断

- 68个可屏蔽中断通道，包含EXTI、TIM、ADC、USART、SPI、I2C、RTC等多个外设。

- 使用NVIC统一管理中断，每个中断通道都拥有16个可编程的优先等级，可对优先级进行分组，进一步设置抢占优先级和响应优先级。

![Image](https://github.com/user-attachments/assets/c2f3cd5e-4960-493d-8676-72af498fce33)
![Image](https://github.com/user-attachments/assets/b125fded-a958-417c-898e-6e9979043855)
![Image](https://github.com/user-attachments/assets/267d7843-0515-4bd0-834c-43c3a92ae384)



## NVIC 基本结构

NVIC，嵌套中断向量控制器。用于统一分配中断优先级和管理中断，是一个内核外设。

为了避免CPU出现过多线引，并且中断同时申请，产生很多拥堵，设计了一个叫号系统，这就是NVIC。

### NVIC 优先级分组

为了处理不同的优先级，采用了分组的设计，NVIC的中断优先级由优先级寄存器的4位（0-15）决定，这4位可以进行切分，分为高$n$位的抢占优先级

抢占优先级高的可以中断嵌套。响应优先级高的可以优先排队，抢占优先级和响应优先级均相同的按中断号排队。

## NVIC 配置函数

### 初始化

首先我们来看下基本的几个结构体：

NVIC_Type:  中断控制器的寄存器结构体，包含了中断使能寄存器、中断优先级寄存器等。

```C
typedef struct
{
  __IO uint32_t ISER[8];                      
       uint32_t RESERVED0[24];                                   
  __IO uint32_t ICER[8];                      
       uint32_t RSERVED1[24];                                    
  __IO uint32_t ISPR[8];                      
       uint32_t RESERVED2[24];                                   
  __IO uint32_t ICPR[8];                      
       uint32_t RESERVED3[24];                                   
  __IO uint32_t IABR[8];                      
       uint32_t RESERVED4[56];                                   
  __IO uint8_t  IP[240];                      
       uint32_t RESERVED5[644];                                  
  __O  uint32_t STIR;                         
}NVIC_Type; 
```

NVIC_InitTypeDef:  中断初始化结构体，包含了中断通道、中断优先级、中断使能等信息。

```C
typedef struct
{
  uint8_t NVIC_IRQChannel;                    
  uint8_t NVIC_IRQChannelPreemptionPriority;  
  uint8_t NVIC_IRQChannelSubPriority;         
  FunctionalState NVIC_IRQChannelCmd;         
} NVIC_InitTypeDef;
```
NVIC_PriorityGroupConfig:  中断优先级分组函数，用于设置中断优先级分组。

```C
void NVIC_PriorityGroupConfig(uint32_t NVIC_PriorityGroup)
{
  /* Check the parameters */
  assert_param(IS_NVIC_PRIORITY_GROUP(NVIC_PriorityGroup));
  
  /* Set the PRIGROUP[10:8] bits according to NVIC_PriorityGroup value */
  SCB->AIRCR = AIRCR_VECTKEY_MASK | NVIC_PriorityGroup;
}
```
