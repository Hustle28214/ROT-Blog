
import WordCount from '../../../../src/components/WordCount/WordCount.jsx';
import Mermaid from '@theme/Mermaid';

<WordCount>

## 1. 通信接口

通信的目的：将一个设备的数据传送到另一个设备，扩展硬件系统

通信协议：制定通信的规则，通信双方按照协议规则进行数据收发

![Image](https://github.com/user-attachments/assets/55fa81cb-b8df-4218-9b00-53dc3b513855)

前三个还应该加一个GND引脚，不然没法通信。

使用差分信号可以极大地提升抗干扰特性，一般差分信号的传输速度和距离都会非常高。

USB有需要单端信号的地方，需要共地。

## 2. 串口通信

串口是一种应用十分广泛的通讯接口，串口成本低、容易使用、通信线路简单，可实现两个设备的互相通信。

单片机的串口可以使单片机与单片机、单片机与电脑、单片机与各式各样的模块互相通信，极大地扩展了单片机的应用范围，增强了单片机系统的硬件实力。


## 3. 硬件电路

- 简单双向串口通信有两根通信线（发送端TX和接收端RX）
- TX与RX要交叉连接
- 当只需单向的数据传输时，可以只接一根通信线
- 当电平标准不一致时，需要加电平转换芯片

![Image](https://github.com/user-attachments/assets/c75a187e-1938-4336-a0b7-1fbaa8a795c0)

GND也是通信线。

## 4. 电平标准

电平标准是数据1和数据0的表达方式，是传输线缆中人为规定的电压与数据的对应关系，串口常用的电平标准有如下三种：

- TTL电平：+3.3V或+5V表示1，0V表示0
- RS232电平：-3~-15V表示1，+3~+15V表示0
- RS485电平：两线压差+2~+6V表示1，-2~-6V表示0（差分信号）

STM32基本是基于TTL电平讨论，因为是3.3V的器件。

## 5. 串口参数及时序

串口中，每一个字节都装载在一个数据帧里面。数据帧由起始位、数据位、（奇偶校验位）、停止位组成，

- 波特率：串口通信的速率
- 起始位：标志一个数据帧的开始，固定为低电平
- 数据位：数据帧的有效载荷，1为高电平，0为低电平，低位先行
- 校验位：用于数据验证，根据数据位计算得来
- 停止位：用于数据帧间隔，固定为高电平



![Image](https://github.com/user-attachments/assets/0fc2acb8-86e5-454c-8535-42deca35b965)

空闲状态必须置高电平。也就是说，没有数据传输的时候，引脚必须要置高电平作为空闲状态，

### 串口时序

![Image](https://github.com/user-attachments/assets/1fcafda8-fcc1-4091-887e-5972f6b61eff)

## 6. USART简介

USART（Universal Synchronous/Asynchronous Receiver/Transmitter）通用同步/异步收发器

USART是STM32内部集成的硬件外设，可根据数据寄存器的一个字节数据自动生成数据帧时序，从TX引脚发送出去，也可自动接收RX引脚的数据帧时序，拼接为一个字节数据，存放在数据寄存器里

- 自带波特率发生器，最高达4.5Mbits/s
- 可配置数据位长度（8/9）、停止位长度（0.5/1/1.5/2）
- 可选校验位（无校验/奇校验/偶校验）
- 支持同步模式、硬件流控制、DMA、智能卡、IrDA、LIN

STM32F103C8T6 USART资源： USART1、 USART2、 USART3

## 7. USART基本结构

![Image](https://github.com/user-attachments/assets/023756ae-cdf8-4f25-b225-92c752370e96)



![Image](https://github.com/user-attachments/assets/e4ce0102-97cc-46ab-988b-947e24771770)

最左边是波特率发生器，时钟来源是PCLK2或1，经过波特率发生器分频后，产生的时钟通向发送控制器和接收控制器，其用于控制发送移位和接收移位，之后，由发送数据寄存器和发送移位寄存器这两个寄存器的配合，将数据一位一位地移出去，通过GPIO的复用输出，输出到TX引脚，产生串口协议规定的波形。移位寄存器是低位先行的。

当数据由数据寄存器转到移位寄存器时，置一个TXE的标志位，判断这个标志位就可以是不是可以写下一个数据。

RX引脚的波形，通过GPIO输入，在接收控制器的控制下，一位一位地移入接收移位寄存器。这里是右移的，低位先行，从左边开始移进来。移完一帧数据后，数据就会统一转运到接收数据寄存器，在转移的同时，置一个RXNE标志位，检查该标志位即可得知是否收到数据。这个标志位还可以申请中断，这样就可以在收到数据时，直接进入中断函数，快速读取、保存数据。

这里实际上只有一个DR寄存器可以供读写。写入DR时，数据走上面的路进行发送，读取DR时，数据走下面的路进行接收。

开关控制：配置完成后，用Cmd开启一下外设。

## 8. 数据帧

![Image](https://github.com/user-attachments/assets/fe3d5e17-48d2-4940-9d4f-a1afe97417a9)

9位字长：

第一条时序，是TX发送或者RX接收的数据帧格式，空闲高电平，起始位0，根据写入的数据，置1或者0，依次发送位0到位8，加起来就是9位，最后停止位1，数据帧结束。（8位有效载荷正好对应一个字节）

每个数据位的中间都有一个时钟上升沿。时钟的频率和数据速率一致。接收端可以在时钟上升沿进行采样，可以精准定位每一位数据。时钟的最后一位，可以通过LBCL位控制要不要输出。时钟的极性、相位都可以通过配置寄存器配置。

空闲帧从头到尾都是1，断开帧从头到尾都是0，是局域网协议用的。


8位字长：

数据位从位0一直到位7，总共是8位，比上面少了一个位8。最后一位位7，也是一个可能的奇偶校验位，但最好选择无校验（因为字长的原因）。

![Image](https://github.com/user-attachments/assets/9e7ff301-35e8-42d3-8019-3ef2d704f808)

STM32的串口可以配置停止位为0.5、1、1.5、2。这四种参数的区别就是停止位的时长不一样。

![Image](https://github.com/user-attachments/assets/802b0abd-de80-460c-a8ee-3991522467ad)

当输入电路侦测到一个数据帧的起始位后，就会以波特率的频率连续采样一帧数据，同时，从起始位开始，采样位置就要对齐到位的正中间，只要第一位对齐了，后面肯定都是对齐的。

输入的部分电路对采样时钟进行了细分，会以波特率的16倍频率进行采样。在一位的时间里，可以进行16次采样，最开始，空闲状态高电平，采样就一直是1，某个位置突然采到0，就说明在两次采样之间出现了下降沿。如果没有任何噪声，之后即为起始位。




</WordCount>